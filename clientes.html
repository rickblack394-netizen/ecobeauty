<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecobeauty - clientes</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* [Se mantiene el bloque de estilos CSS] */
        :root {
            --primary-color: #7C9D6E;
            --secondary-color: #dbd2c5;
            --accent-color: #4A6741;
        }
        
        .hero {
            position: relative;
            height: 80vh;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .hero video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        .hero > * {
            z-index: 1;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(124, 157, 110, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(124, 157, 110, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(124, 157, 110, 0);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        .btn-eco {
            background-color: var(--primary-color);
            color: white;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .btn-eco::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-eco:hover::before {
            left: 100%;
        }

        .btn-eco:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35), 0 0 20px rgba(124, 157, 110, 0.5);
            animation: pulse 0.6s ease-out;
        }

        .btn-eco:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            letter-spacing: 1px;
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
            letter-spacing: 0.5px;
        }

        .btn-secondary:hover:not(:disabled) {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .add-to-cart-btn {
            animation: bounce 2s infinite;
            animation-delay: 0s;
        }

        .add-to-cart-btn:hover {
            animation: none;
        }

        .feature-card {
            transition: transform 360ms cubic-bezier(.2,.9,.2,1), box-shadow 360ms cubic-bezier(.2,.9,.2,1);
            transform-origin: center bottom;
            transform-style: preserve-3d;
            will-change: transform, box-shadow;
        }

        /* Hover: pop forward with subtle 3D tilt and deeper shadow */
        .feature-card:hover {
            transform: translateY(-14px) translateZ(0) scale(5) rotateX(2deg);
            z-index: 6;
            box-shadow: 0 18px 36px rgba(0,0,0,0.22), 0 6px 18px rgba(0,0,0,0.12);
        }

        /* Slight image parallax inside the card for depth */
        .feature-card .product-img {
            transition: transform 420ms cubic-bezier(.2,.9,.2,1);
            backface-visibility: hidden;
        }

        .feature-card:hover .product-img {
            transform: translateY(-6px) scale(1.02);
        }
        
        /* Animaciones de entrada para productos */
        @keyframes fade-up {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slide-left {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes zoom-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .anim-fade-up { animation: fade-up 450ms cubic-bezier(.2,.9,.2,1) both; animation-delay: var(--entrance-delay, 0ms); }
        .anim-slide-left { animation: slide-left 500ms cubic-bezier(.2,.9,.2,1) both; animation-delay: var(--entrance-delay, 0ms); }
        .anim-zoom-in { animation: zoom-in 420ms cubic-bezier(.2,.9,.2,1) both; animation-delay: var(--entrance-delay, 0ms); }

        /* Helper: staggered children (delay will be set inline) */
        .product-animated { opacity: 0; }

        /* Card base styles (keep relative positioning and transition) */
        .card {
            position: relative;
            transition: transform 260ms cubic-bezier(.2,.9,.2,1);
            will-change: transform;
        }

        /* Animaciones de salida (out) */
        @keyframes fade-down-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(12px); }
        }

        @keyframes slide-right-out {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(24px); }
        }

        @keyframes zoom-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.96); }
        }

        .anim-fade-down-out { animation: fade-down-out 320ms ease both; animation-delay: var(--exit-delay, 0ms); }
        .anim-slide-right-out { animation: slide-right-out 360ms ease both; animation-delay: var(--exit-delay, 0ms); }
        .anim-zoom-out { animation: zoom-out 300ms ease both; animation-delay: var(--exit-delay, 0ms); }

        /* Floating animation for feature cards while on page */
        @keyframes float-y {
            0% { transform: translateY(0); }
            50% { transform: translateY(-9px); }
            100% { transform: translateY(0); }
        }

        .feature-card {
            /* keep existing transitions, float will be layered after entrance via delay */
            animation-name: float-y;
            /* Faster and stronger float: shorter duration and larger amplitude */
            animation-duration: 3s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            animation-direction: alternate;
            /* start float after entrance: --entrance-delay + 400ms for snappier behavior */
            animation-delay: calc(var(--entrance-delay, 0ms) + 400ms);
            transform-origin: center bottom;
            will-change: transform;
        }

        

        .eco-bg {
            background-color: var(--secondary-color);
        }

        .footer {
            background-color: var(--accent-color);
            color: white;
        }

        /* Estilo para el Toast de confirmación */
        .toast-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1080; 
        }
        .product-img {
            height: 250px; /* Altura fija para todas las imágenes */
            object-fit: cover; /* Asegura que la imagen cubra el espacio sin distorsionarse */
        }

        /* Efecto de partículas siguiendo el mouse */
        .particle-cursor {
            position: fixed;
            pointer-events: none;
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle at 30% 30%, rgba(124, 157, 110, 0.8), rgba(124, 157, 110, 0.3));
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(124, 157, 110, 0.6);
            animation: particle-fade 1s ease-out forwards;
        }

        @keyframes particle-fade {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container toast-custom">
        <div id="checkoutToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i> ¡Compra Finalizada con Éxito! Gracias por tu pedido.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"><img src="Flor.png" width="100">
                 EcoBeauty
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item me-3">
                        <div class="input-group" style="width: 200px;">
                            <input type="text" class="form-control" id="search-input" placeholder="Buscar productos..." style="border-radius: 20px 0 0 20px;">
                            <button class="btn btn-eco" type="button" id="search-btn" style="border-radius: 0 20px 20px 0;">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="fas fa-shopping-cart fa-lg"></i>
                            <span id="cart-count" class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#inicio">Inicio</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            Categorías
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#todos">Todo</a></li>
                            <li><a class="dropdown-item" href="#cabello">Cabello</a></li>
                            <li><a class="dropdown-item" href="#cuerpo">Cuerpo</a></li>
                            <li><a class="dropdown-item" href="#rostro">Rostro</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#nosotros">Nosotros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#contacto">Contacto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html">Administrador</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="hero d-flex align-items-center" id="inicio">
        <video autoplay muted loop playsinline>
            <source src="baground.mp4" type="video/mp4">
            Tu navegador no soporta videos HTML5
        </video>
        <div class="container text-center">
            <h1 class="display-3 fw-bold mb-4">Belleza Natural y Consciente</h1>
            <p class="lead mb-4">Descubre nuestra línea de cosméticos naturales, libres de químicos y crueldad animal</p>
            <a href="#productos-dinamicos"><button class="btn btn-eco btn-lg">Ver Productos</button></a>
        </div>
    </section>

    <section class="py-5" id="productos-dinamicos">
        <div class="container">
            <h2 class="text-center mb-5">Nuestros Productos</h2>
            <div id="products-container" class="row g-4">
                </div>
            <div id="loading-spinner" class="text-center mt-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando productos...</span>
                </div>
                <p class="text-success mt-2">Cargando productos...</p>
            </div>
        </div>
    </section>
    
    <section class="py-5 eco-bg" id="nosotros">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-4">Sobre Ecobeauty</h2>
                    <p class="lead">Somos una marca comprometida con tu belleza y el medio ambiente.</p>
                    <p>En Ecobeauty, creemos en la belleza natural y sostenible. Todos nuestros productos están:</p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i> Elaborados con ingredientes naturales</li>
                        <li><i class="fas fa-check text-success me-2"></i> Libres de crueldad animal</li>
                        <li><i class="fas fa-check text-success me-2"></i> Respetuosos con el medio ambiente</li>
                        <li><i class="fas fa-check text-success me-2"></i> Certificados orgánicos</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <img src="https://images.unsplash.com/photo-1576426863848-c21f53c60b19?auto=format&fit=crop&w=600&q=80" alt="Sobre Nosotros" class="img-fluid rounded">
                </div>
            </div>
        </div>
    </section>

    <section class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">¿Por qué elegir cosmética natural?</h2>
            <div class="row g-4">
                <div class="col-md-3 text-center">
                    <i class="fas fa-heart fa-3x text-success mb-3"></i>
                    <h4>Saludable</h4>
                    <p>Sin químicos dañinos para tu piel</p>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-leaf fa-3x text-success mb-3"></i>
                    <h4>Natural</h4>
                    <p>100% ingredientes naturales</p>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-globe fa-3x text-success mb-3"></i>
                    <h4>Sostenible</h4>
                    <p>Respetuoso con el planeta</p>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-paw fa-3x text-success mb-3"></i>
                    <h4>Cruelty-Free</h4>
                    <p>No testado en animales</p>
                </div>
            </div>
        </div>
    </section>

    <section class="py-5 eco-bg" id="contacto">
        <div class="container">
            <h2 class="text-center mb-5">Contáctanos</h2>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <form>
                        <div class="mb-3">
                            <input type="text" class="form-control" placeholder="Nombre">
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control" placeholder="Email">
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" rows="4" placeholder="Mensaje"></textarea>
                        </div>
                        <button type="submit" class="btn btn-eco w-100">Enviar Mensaje</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="fas fa-leaf"></i> Ecobeauty</h5>
                    <p>Tu belleza, naturalmente.</p>
                </div>
                <div class="col-md-4">
                    <h5>Contacto</h5>
                    <p><i class="fas fa-envelope me-2"></i> info@ecobeauty.com</p>
                    <p><i class="fas fa-phone me-2"></i> (123) 456-7890</p>
                </div>
                <div class="col-md-4">
                    <h5>Síguenos</h5>
                    <div class="social-icons">
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>


    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel"><i class="fas fa-shopping-basket me-2"></i> Tu Carrito de Compras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cart-items-container">
                        <p class="text-center text-muted">El carrito está vacío.</p>
                    </div>
                    
                    <h4 class="mt-4 text-end">Total: <span id="cart-total">$0.00</span></h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-eco" id="checkout-btn" onclick="checkout()">Finalizar Compra</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        
        // --- INICIALIZACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUyBMozRQIrGNSp-Ktxp29IDHwcZOclfo",
            authDomain: "primer-proyecto-6b573.firebaseapp.com",
            projectId: "primer-proyecto-6b573",
            storageBucket: "primer-proyecto-6b573.firebasestorage.app",
            messagingSenderId: "26196704025",
            appId: "1:26196704025:web:81c0ec682c1cef92722388",
            measurementId: "G-GNZL686L9C"
        };
        
        // Importa las funciones necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, query, orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const productsContainer = document.getElementById('products-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Función auxiliar para formato de moneda (del admin.html)
        function currencyMX(n){
            return Number(n||0).toLocaleString('es-MX',{
                minimumFractionDigits:2,
                maximumFractionDigits:2
            });
        }
        
        // Variable para controlar la animación actual según categoría
        let currentAnimationClass = 'anim-fade-up';

        // Mapeo categoría -> clase de animación
        const categoryAnimationMap = {
            'cabello': 'anim-slide-left',
            'cuerpo': 'anim-zoom-in',
            'rostro': 'anim-fade-up',
            'todos': 'anim-fade-up'
        };

        // Mapeo para animaciones de salida (cuando se cambie la categoría)
        const categoryOutMap = {
            'cabello': 'anim-slide-right-out',
            'cuerpo': 'anim-zoom-out',
            'rostro': 'anim-fade-down-out',
            'todos': 'anim-fade-down-out',
            'search': 'anim-zoom-out'
        };

        // Función que anima hacia fuera los productos actuales y luego renderiza los nuevos
        function animateOutThenRender(newProducts, category) {
            const outClass = categoryOutMap[category] || 'anim-fade-down-out';
            const cards = productsContainer.querySelectorAll('.card');

            if (!cards || cards.length === 0) {
                // nothing to animate out
                currentAnimationClass = categoryAnimationMap[category] || 'anim-fade-up';
                renderProducts(newProducts);
                return;
            }

            // Apply out animation with a small stagger
            cards.forEach((card, i) => {
                // ensure previous entrance classes are removed to avoid conflicting animations
                card.classList.remove('anim-fade-up', 'anim-slide-left', 'anim-zoom-in');
                card.classList.add(outClass);
                // set a per-card exit delay variable so it doesn't overwrite entrance timing
                card.style.setProperty('--exit-delay', `${i * 50}ms`);
            });

            // Wait for the animations to finish before rendering new products
            const maxDelay = (cards.length - 1) * 50;
            const outDuration = 380; // ms (matches CSS durations)
            setTimeout(() => {
                // reset
                currentAnimationClass = categoryAnimationMap[category] || 'anim-fade-up';
                renderProducts(newProducts);
            }, maxDelay + outDuration);
        }

        
        // Función para renderizar los productos desde Firestore
        function renderProducts(productos) {
            productsContainer.innerHTML = ''; // Limpia el contenedor estático
            loadingSpinner.style.display = 'none';
            
            if (productos.length === 0) {
                productsContainer.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-5x text-muted"></i>
                        <h4 class="text-muted mt-3">Pronto habrá nuevos productos</h4>
                        <p class="text-muted">El administrador aún no ha agregado productos.</p>
                    </div>
                `;
                return;
            }

            productos.forEach((p, idx) => {
                const col = document.createElement('div');
                col.className = 'col-md-4'; 
                
                // Determina la URL de la imagen (usa la primera de la lista o un placeholder)
                const imageUrl = (Array.isArray(p.imagenes) && p.imagenes.length > 0) 
                    ? p.imagenes[0]
                    : 'https://via.placeholder.com/400x300?text=EcoBeauty';
                col.innerHTML = `
                    <div class="card feature-card h-100 shadow-sm">
                        <img src="${imageUrl}" class="card-img-top product-img" alt="${p.nombre}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${p.nombre}</h5>
                            <p class="card-text small text-muted mb-2">${p.descripcion.substring(0, 70)}${p.descripcion.length > 70 ? '...' : ''}</p>
                            <p class="fw-bold mb-1 mt-auto">Precio: $${currencyMX(p.precio)}</p>
                            <p class="small text-muted mb-2">Categoría: ${p.categoria}</p>
                            
                            <button 
                                class="btn btn-eco add-to-cart-btn mt-2" 
                                data-id="${p._id}" 
                                data-name="${p.nombre}" 
                                data-price="${p.precio}"
                                ${p.stock <= 0 ? 'disabled' : ''}
                            >
                                <i class="fas fa-cart-plus me-1"></i> 
                                ${p.stock <= 0 ? 'Agotado' : 'Agregar al Carrito'}
                            </button>
                        </div>
                    </div>
                `;
                productsContainer.appendChild(col);

                // Aplica animación de entrada con stagger
                const card = col.querySelector('.card');
                if (card) {
                    // Add a baseline class to allow opacity before animation
                    card.classList.add('product-animated');
                    // Use the currentAnimationClass set by filter/search
                    card.classList.add(currentAnimationClass);
                    // Stagger via CSS variable so float animation can reference it
                    card.style.setProperty('--entrance-delay', `${idx * 80}ms`);
                    // Ensure opacity becomes visible after animation starts
                    card.style.opacity = '1';
                }
            });
            
            // Asigna los listeners de "Agregar al Carrito" a los nuevos botones
            assignCartListeners();
        }

        // --- FILTRADO DE CATEGORÍAS ---
        let allProducts = []; // Almacena todos los productos
        
        // Listener de Firestore (similar al de admin.html)
        const productosRef = collection(db, 'productos');
        // Ordena por fecha de creación (los más nuevos primero)
        const q = query(productosRef, orderBy('createdAt', 'desc')); 

        onSnapshot(q, (snap) => {
            allProducts = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
            renderProducts(allProducts);
        });

        // Función para filtrar por categoría
        function filterByCategory(category) {
            // Set current animation based on category
            // Use animate-out -> render-in flow
            const targetAnim = categoryAnimationMap[category] || 'anim-fade-up';
            const filtered = (category === 'todos') ? allProducts : allProducts.filter(p => p.categoria && p.categoria.toLowerCase() === category.toLowerCase());
            // Trigger out animation and then render filtered
            animateOutThenRender(filtered, category);
        }

        // Captura los clics en los enlaces de categoría
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a[href*="#todos"], a[href*="#cabello"], a[href*="#cuerpo"], a[href*="#rostro"]');
            if (link) {
                e.preventDefault();
                const href = link.getAttribute('href');
                const category = href.substring(1); // Elimina el #
                filterByCategory(category);
                
                // Desplaza hacia la sección de productos
                setTimeout(() => {
                    document.getElementById('productos-dinamicos').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        });

        // --- FUNCIÓN DE BÚSQUEDA ---
        function searchProducts(query) {
            if (!query.trim()) {
                // reset to default animation for full list
                animateOutThenRender(allProducts, 'todos');
                return;
            }

            const queryLower = query.toLowerCase();
            const filtered = allProducts.filter(p => 
                (p.nombre && p.nombre.toLowerCase().includes(queryLower)) ||
                (p.descripcion && p.descripcion.toLowerCase().includes(queryLower)) ||
                (p.categoria && p.categoria.toLowerCase().includes(queryLower))
            );
            // Use a neutral animation for search results
            // animate out current and show filtered
            animateOutThenRender(filtered, 'search');
        }

        // Listeners para la barra de búsqueda
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        if (searchInput && searchBtn) {
            searchBtn.addEventListener('click', () => {
                searchProducts(searchInput.value);
                document.getElementById('productos-dinamicos').scrollIntoView({ behavior: 'smooth' });
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchProducts(searchInput.value);
                    document.getElementById('productos-dinamicos').scrollIntoView({ behavior: 'smooth' });
                }
            });
        }

        // Captura los clics en los enlaces de categoría

        // --- FUNCIONES CORE DEL CARRITO (Se reubican aquí para usar 'type="module"') ---
        
        // La clave de LocalStorage es CLAVE para la sincronización
        const LS_CART_KEY = 'ecobeautyCart';
        
        function getCart() {
            const cartString = localStorage.getItem(LS_CART_KEY);
            return cartString ? JSON.parse(cartString) : [];
        }

        function saveCart(cart) {
            localStorage.setItem(LS_CART_KEY, JSON.stringify(cart));
        }

        function updateCartCount() {
            const cart = getCart();
            const countElement = document.getElementById('cart-count');
            
            const totalItems = cart.reduce((total, product) => total + product.quantity, 0);
            
            countElement.textContent = totalItems;
            countElement.style.display = totalItems > 0 ? 'inline-block' : 'none';
        }

        function addToCart(product) {
            let cart = getCart();
            const existingProductIndex = cart.findIndex(item => item.id === product.id);

            if (existingProductIndex > -1) {
                cart[existingProductIndex].quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            saveCart(cart);
            updateCartCount();
        }
        
        // Estas funciones se vuelven globales para el onclick en el Modal
        window.changeQuantity = function(productId, amount) {
            let cart = getCart();
            const productIndex = cart.findIndex(item => item.id === productId);

            if (productIndex > -1) {
                cart[productIndex].quantity += amount;
                
                if (cart[productIndex].quantity <= 0) {
                    cart.splice(productIndex, 1);
                }
            }
            
            saveCart(cart);
            updateCartCount();
            renderCartItems(); 
        }
        
        window.removeFromCart = function(productId) {
            let cart = getCart();
            cart = cart.filter(item => item.id !== productId);
            
            saveCart(cart);
            updateCartCount();
            renderCartItems();
        }

        function renderCartItems() {
            const cart = getCart();
            const container = document.getElementById('cart-items-container');
            const totalElement = document.getElementById('cart-total');
            const checkoutButton = document.getElementById('checkout-btn');
            
            let totalCost = 0;
            let html = '';

            if (cart.length === 0) {
                html = '<p class="text-center text-muted">El carrito está vacío. ¡Empieza a agregar productos!</p>';
                checkoutButton.disabled = true;
            } else {
                html = '<ul class="list-group">';
                
                cart.forEach(product => {
                    const price = parseFloat(product.price) || 0;
                    const subtotal = price * product.quantity;
                    totalCost += subtotal;
                    
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div class="d-flex align-items-center w-50">
                                <strong>${product.name}</strong> 
                            </div>

                            <div class="d-flex align-items-center">
                                <div class="btn-group btn-group-sm me-3" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeQuantity('${product.id}', -1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="btn btn-light" style="width: 40px; pointer-events: none;">${product.quantity}</span>
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeQuantity('${product.id}', 1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                
                                <div class="text-end me-3">
                                    $${price.toFixed(2)} c/u<br>
                                    <strong>$${subtotal.toFixed(2)}</strong>
                                </div>

                                <button type="button" class="btn btn-danger btn-sm" onclick="removeFromCart('${product.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </li>
                    `;
                });
                
                html += '</ul>';
                checkoutButton.disabled = false;
            }

            container.innerHTML = html;
            totalElement.textContent = `$${totalCost.toFixed(2)}`;
        }
        
        window.checkout = function() {
            const cart = getCart();
            
            if (cart.length === 0) {
                alert('Tu carrito está vacío. No hay nada que comprar.');
                return;
            }
            
            localStorage.removeItem(LS_CART_KEY);
            updateCartCount();
            
            const cartModalElement = document.getElementById('cartModal');
            const modal = bootstrap.Modal.getInstance(cartModalElement) || new bootstrap.Modal(cartModalElement);
            modal.hide();
            
            const checkoutToast = document.getElementById('checkoutToast');
            const toast = new bootstrap.Toast(checkoutToast);
            toast.show();
            
            // Recarga los productos del carrito vacío
            renderCartItems(); 
        }

        // Asigna listeners a los botones "Agregar al Carrito"
        function assignCartListeners() {
            const buttons = document.querySelectorAll('.add-to-cart-btn');
            buttons.forEach(button => {
                // Elimina el listener anterior para evitar duplicados
                button.removeEventListener('click', handleAddToCartClick);
                // Asigna el nuevo listener
                button.addEventListener('click', handleAddToCartClick);
            });
        }
        
        function handleAddToCartClick() {
             const id = this.getAttribute('data-id');
             const name = this.getAttribute('data-name');
             const price = parseFloat(this.getAttribute('data-price')); 
             const product = { id, name, price };
             addToCart(product);
        }

        // (Hover particle emitters removed)

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            updateCartCount();

            // Escuchar la apertura del Modal para cargar los productos
            const cartModal = document.getElementById('cartModal');
            if(cartModal) {
                 cartModal.addEventListener('show.bs.modal', renderCartItems);
                 // Inicializa el modal para que pueda ser llamado
                 new bootstrap.Modal(cartModal); 
            }
            
            // Los listeners de los botones se asignarán después de que Firebase cargue los productos
        });
    </script>

    <script>
        // Efecto de partículas siguiendo el mouse
        const particleContainer = document.body;
        let mouseX = 0;
        let mouseY = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;

            // Crear partículas en cada movimiento del mouse
            createParticle(mouseX, mouseY);
        });

        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle-cursor';
            
            // Dirección aleatoria para las partículas
            const randomX = (Math.random() - 0.5) * 100;
            const randomY = (Math.random() - 0.5) * 100;
            
            particle.style.setProperty('--tx', randomX + 'px');
            particle.style.setProperty('--ty', randomY + 'px');
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            
            // Tamaño aleatorio
            const randomSize = 5 + Math.random() * 10;
            particle.style.width = randomSize + 'px';
            particle.style.height = randomSize + 'px';
            
            particleContainer.appendChild(particle);
            
            // Eliminar la partícula después de la animación
            setTimeout(() => particle.remove(), 1000);
        }
    </script>
</body>
</html>